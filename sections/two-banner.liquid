{%- liquid
  assign section_classes = 'two-banner two-banner--' | append: section.id

  assign block_count = section.blocks.size | at_least: 1

  assign cols_mobile  = section.settings.columns_mobile  | default: '1' | plus: 0 | at_least: 1 | at_most: block_count
  assign cols_desktop = section.settings.columns_desktop | default: 2   | plus: 0 | at_least: 1 | at_most: block_count

  assign mobile_vw  = 100 | divided_by: cols_mobile
  assign desktop_vw = 100 | divided_by: cols_desktop
-%}

<div id="section-id-{{ section.id }}" class="{% if section.settings.overlap_header %}header-overlap-section needs-alt-logo{% endif %}">
<section
  class="{{ section_classes }} {% if section.settings.sticky_desktop %}is-sticky-desktop{% endif %} {% if section.settings.sticky_mobile_item %}is-sticky-mobile{% endif %}"
  data-section-id="{{ section.id }}"
  data-cols-mobile="{{ cols_mobile }}"
  data-cols-desktop="{{ cols_desktop }}"
  style="
    --sticky-offset-desktop: {{ section.settings.sticky_offset_desktop | default: 0 }}px;
    --sticky-offset-mobile: {{ section.settings.sticky_offset_mobile | default: 0 }}px;
    --sticky-z-index: {{ section.settings.sticky_z_index | default: 1000 }};
  "
>
  <style>
    .two-banner--{{ section.id }} .two-banner__grid {
      display: grid;
      grid-template-columns: repeat({{ cols_mobile }}, minmax(0, 1fr));
      gap: {{ section.settings.gap | default: 16 }}px;
    }
    @media (min-width: 750px) {
      .two-banner--{{ section.id }} .two-banner__grid {
        grid-template-columns: repeat({{ cols_desktop }}, minmax(0, 1fr));
      }
    }

    .two-banner--{{ section.id }} .two-banner__item { position: relative; overflow: hidden; }

    .two-banner--{{ section.id }} .two-banner__media {
      aspect-ratio: var(--ratio-mobile, 1.7778);
    }
    @media (min-width: 769px) {
      .two-banner--{{ section.id }} .two-banner__media {
        aspect-ratio: var(--ratio-desktop, var(--ratio-mobile, 1.7778));
      }
    }

    .two-banner--{{ section.id }} .two-banner__media img,
    .two-banner--{{ section.id }} .two-banner__media video,
    .two-banner--{{ section.id }} .two-banner__media iframe {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }

    @media (min-width: 769px) {
      .two-banner--{{ section.id }}.is-sticky-desktop {
        position: sticky;
        top: var(--sticky-offset-desktop);
        z-index: var(--sticky-z-index);
      }
    }

    @media (max-width: 768px) {
      .two-banner--{{ section.id }}.is-sticky-mobile[data-cols-mobile="1"] .two-banner__item {
        position: sticky;
        top: var(--sticky-offset-mobile);
        z-index: var(--sticky-z-index);
      }
    }

    .two-banner--{{ section.id }} .two-banner__overlay {
      position: absolute;
      inset: 0;
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 5;
      pointer-events: none;
    }
    .two-banner--{{ section.id }} .two-banner__overlay.h-left { justify-content: flex-start; }
    .two-banner--{{ section.id }} .two-banner__overlay.h-right { justify-content: flex-end; }
    .two-banner--{{ section.id }} .two-banner__overlay.v-top { align-items: flex-start; }
    .two-banner--{{ section.id }} .two-banner__overlay.v-bottom { align-items: flex-end; }

    .two-banner--{{ section.id }} .two-banner__title-wrapper {
      color: var(--title-color, #fff);
      background: var(--bg-color, transparent);
      transform: translate(var(--x, 0), var(--y, 0));
    }

    .two-banner--{{ section.id }} .two-banner__link {
      position: absolute;
      inset: 0;
      z-index: 10;
    }
  </style>

  <div class="two-banner__grid">
    {%- for block in section.blocks -%}
      {%- liquid
        assign img_desktop = block.settings.image_desktop | default: block.settings.image
        assign img_mobile  = block.settings.image_mobile  | default: block.settings.image
        assign vid  = block.settings.video
        assign vurl = block.settings.video_url
        assign poster_image = img_desktop

        assign ar_mobile = block.settings.aspect_ratio_mobile
        assign ar_desktop = block.settings.aspect_ratio_desktop

        assign ratio_mobile = ''
        if ar_mobile == '1_1'
          assign ratio_mobile = '1/1'
        elsif ar_mobile == '2_3'
          assign ratio_mobile = '2/3'
        elsif ar_mobile == '3_2'
          assign ratio_mobile = '3/2'
        elsif ar_mobile == '4_3'
          assign ratio_mobile = '4/3'
        elsif ar_mobile == '16_9'
          assign ratio_mobile = '16/9'
        else
          assign ratio_mobile = img_mobile.aspect_ratio | default: 1.7778
        endif

        assign ratio_desktop = ''
        if ar_desktop == '1_1'
          assign ratio_desktop = '1/1'
        elsif ar_desktop == '2_3'
          assign ratio_desktop = '2/3'
        elsif ar_desktop == '3_2'
          assign ratio_desktop = '3/2'
        elsif ar_desktop == '4_3'
          assign ratio_desktop = '4/3'
        elsif ar_desktop == '16_9'
          assign ratio_desktop = '16/9'
        else
          assign ratio_desktop = img_desktop.aspect_ratio | default: ratio_mobile
        endif
      -%}

      <div class="two-banner__item" {{ block.shopify_attributes }}>
        <div class="two-banner__media" style="--ratio-mobile: {{ ratio_mobile }}; --ratio-desktop: {{ ratio_desktop }};">
          {% if vid != blank %}
            {% render 'inline-video', video_shopify: vid, image: poster_image, autoplay: false, loop: block.settings.video_loop %}
          {% elsif img_desktop != blank or img_mobile != blank %}
            <picture>
              {% if img_mobile != blank %}
                <source media="(max-width: 768px)"
                        srcset="{{ img_mobile | image_url: width: 1000 }}"
                        sizes="{{ mobile_vw }}vw">
              {% endif %}
              {% if img_desktop != blank %}
                <source media="(min-width: 769px)"
                        srcset="{{ img_desktop | image_url: width: 2000 }}"
                        sizes="{{ desktop_vw }}vw">
              {% endif %}
              <img src="{{ img_desktop | image_url: width: 1200 }}"
                   alt="{{ block.settings.title | escape }}"
                   loading="lazy">
            </picture>
          {% endif %}
        </div>

        <div class="two-banner__overlay h-{{ block.settings.h_align }} v-{{ block.settings.v_align }}">
          <div class="two-banner__title-wrapper"
               style="
                 --title-color: {{ block.settings.title_color }};
                 --bg-color: {{ block.settings.title_bg }};
                 --x: {{ block.settings.x_offset }}px;
                 --y: {{ block.settings.y_offset }}px;
                 text-align: {{ block.settings.text_align }};
                 padding: {{ block.settings.padding }}px;
               ">
            {% if block.settings.title != blank %}
              <div class="two-banner__title">{{ block.settings.title }}</div>
            {% endif %}
          </div>
        </div>

        {% if block.settings.link != blank %}
          <a class="two-banner__link" href="{{ block.settings.link }}"></a>
        {% endif %}
      </div>
    {%- endfor -%}
  </div>
</section>
</div>

{% schema %}
{
  "name": "Two Banners",
  "class": "section-two-banners",
  "settings": [
    { "type": "checkbox", "id": "overlap_header", "label": "Transparent header", "default": false },
    { "type": "range", "id": "gap", "label": "Banner gap", "min": 0, "max": 64, "step": 1, "default": 0 },

    {
      "type": "select",
      "id": "columns_mobile",
      "label": "Số banner / 1 hàng (Mobile)",
      "default": "1",
      "options": [
        { "value": "1", "label": "1 banner" },
        { "value": "2", "label": "2 banner" }
      ]
    },

    {
      "type": "range",
      "id": "columns_desktop",
      "label": "Số banner / 1 hàng (Desktop)",
      "min": 1,
      "max": 6,
      "step": 1,
      "default": 2
    },

    { "type": "checkbox", "id": "sticky_desktop", "label": "Sticky Desktop", "default": true },
    { "type": "checkbox", "id": "sticky_mobile_item", "label": "Sticky Mobile", "default": true },
    { "type": "range", "id": "sticky_offset_desktop", "label": "Offset Desktop", "min": 0, "max": 200, "step": 2, "default": 0 },
    { "type": "range", "id": "sticky_offset_mobile", "label": "Offset Mobile", "min": 0, "max": 200, "step": 2, "default": 0 },
    { "type": "range", "id": "sticky_z_index", "label": "Sticky Z-index", "min": 0, "max": 9900, "step": 100, "default": 1000 }
  ],
  "blocks": [
    {
      "type": "banner",
      "name": "Banner",
      "settings": [
        { "type": "image_picker", "id": "image_desktop", "label": "Ảnh Desktop" },
        { "type": "image_picker", "id": "image_mobile", "label": "Ảnh Mobile" },
        { "type": "image_picker", "id": "image", "label": "Image (Legacy)" },
        { "type": "video", "id": "video", "label": "Shopify Video" },
        { "type": "video_url", "id": "video_url", "label": "Video Youtube/Vimeo", "accept": ["youtube", "vimeo"] },
        { "type": "checkbox", "id": "video_loop", "label": "Loop Video", "default": false },

        {
          "type": "select",
          "id": "aspect_ratio_mobile",
          "label": "Aspect ratio (mobile)",
          "default": "2_3",
          "options": [
            { "label": "Auto (image)", "value": "auto" },
            { "label": "1:1", "value": "1_1" },
            { "label": "2:3", "value": "2_3" },
            { "label": "3:2", "value": "3_2" },
            { "label": "4:3", "value": "4_3" },
            { "label": "16:9", "value": "16_9" }
          ]
        },
        {
          "type": "select",
          "id": "aspect_ratio_desktop",
          "label": "Aspect ratio (desktop)",
          "default": "1_1",
          "options": [
            { "label": "Auto (image)", "value": "auto" },
            { "label": "1:1", "value": "1_1" },
            { "label": "2:3", "value": "2_3" },
            { "label": "3:2", "value": "3_2" },
            { "label": "4:3", "value": "4_3" },
            { "label": "16:9", "value": "16_9" }
          ]
        },

        { "type": "text", "id": "title", "label": "Title" },
        { "type": "color", "id": "title_color", "label": "Color", "default": "#ffffff" },
        { "type": "color", "id": "title_bg", "label": "Background", "default": "rgba(0,0,0,0.4)" },

        { "type": "select", "id": "h_align", "label": "Horizontal Align", "default": "center",
          "options": [
            { "label": "Left", "value": "left" },
            { "label": "Center", "value": "center" },
            { "label": "Right", "value": "right" }
          ]
        },
        { "type": "select", "id": "v_align", "label": "Vertical Align", "default": "middle",
          "options": [
            { "label": "Top", "value": "top" },
            { "label": "Middle", "value": "middle" },
            { "label": "Bottom", "value": "bottom" }
          ]
        },
        { "type": "select", "id": "text_align", "label": "Text Align", "default": "center",
          "options": [
            { "label": "Left", "value": "left" },
            { "label": "Center", "value": "center" },
            { "label": "Right", "value": "right" }
          ]
        },

        { "type": "range", "id": "x_offset", "label": "X offset", "min": -200, "max": 200, "step": 5, "default": 0 },
        { "type": "range", "id": "y_offset", "label": "Y offset", "min": -200, "max": 200, "step": 5, "default": 0 },
        { "type": "range", "id": "padding", "label": "Padding", "min": 0, "max": 60, "step": 1, "default": 12 },

        { "type": "url", "id": "link", "label": "Link" }
      ]
    }
  ],
  "max_blocks": 6,
  "presets": [
    { "name": "Two Banners", "category": "Image" }
  ]
}
{% endschema %}
